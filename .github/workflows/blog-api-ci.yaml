name: Blog API CI

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/blog-api-ci.yaml'
      - 'blog-api/**'
  pull_request:
    paths:
      - '.github/workflows/blog-api-ci.yaml'
      - 'blog-api/**'

permissions:
  contents: write

defaults:
  run:
    working-directory: ./blog-api

jobs:
  lint:
    strategy:
      matrix:
        go: ['>=1.25.5']
        os: [ubuntu-24.04]
    name: lint
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}
      - name: Download dependencies
        run: go mod download
      - name: Generate API documentation
        run: make swagger
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.4.0
          working-directory: ./blog-api
  test:
    needs: lint
    strategy:
      matrix:
        go: ['>=1.25.5']
        os: [ubuntu-24.04]
    name: test
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}
      - name: Download dependencies
        run: go mod download
      - name: Generate API documentation
        run: make swagger
      - name: Run tests with coverage
        run: |
          go list ./... | grep -v -E '(cmd/|docs/|internal/config|internal/database|internal/logger|internal/server|internal/error|internal/health)' | tr '\n' ',' | sed 's/,$//' > /tmp/coverpkg.txt
          go test -v -race -coverprofile=coverage.out -coverpkg=$(cat /tmp/coverpkg.txt) ./...
      - name: Coverage report
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      - name: Generate coverage badge
        if: github.ref == 'refs/heads/main'
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          COLOR="red"
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then COLOR="brightgreen"
          elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then COLOR="yellow"
          elif (( $(echo "$COVERAGE >= 40" | bc -l) )); then COLOR="orange"
          fi
          sed -i "s|coverage-[0-9.]*%25-[a-z]*|coverage-${COVERAGE}%25-${COLOR}|g" README.md
      - name: Commit coverage badge
        if: github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git diff --quiet --cached || git commit -m "chore: update coverage badge [skip ci]"
          git push
